<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InterviewPrep Hackathon</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- <script src="./src/phonemeServe.js"></script> -->
  <script src="helper/visemes.js"></script>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="src/main.js" type="module"></script>
  <script src="src/elevenlabs.js"></script>
  <script src="./src/webkitRecognition.js"></script>
  <script src="./src/prompts.js"></script>
</head>
<style>
  .overlay {
    position: absolute;
    top: 10%;
    left: 10%;
    transform: translateX(-50%);
    z-index: 10;
  }

  .conversation-user {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    max-width: 40%;
    padding: 10px;
    border-radius: 8px;
    color: black;
  }

  .conversation-avatar {
    position: absolute;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    text-align: justify;
    max-width: 30%;
    z-index: 10;
    padding: 10px;
    border-radius: 8px;
    color: black;
  }

  .speak-button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: background-color 0.3s ease;
  }

  .speak-button:hover {
    background-color: #45a049;
  }

  .speak-button.listening {
    background-color: #ff6f00;
  }

  .technical {
    background-color: rosybrown;
  }

  .technical:hover {
    background-color: burlywood;
  }

  .hr {
    background-color: deepskyblue;
  }

  .hr:hover {
    background-color: skyblue;
  }

  .fade-in {
    opacity: 0;
    transition: opacity 0.5s ease-in;
  }

  .fade-in.show {
    opacity: 1;
  }

  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
    z-index: 1;
  }

  .dropdown-content button {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
  }

  .dropdown-content button:hover {
    background-color: #f1f1f1;
  }

  .dropdown:hover .dropdown-content {
    display: block;
  }

  .score-slider-container {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    height: 20px;
    background-color: #ddd;
    border-radius: 10px;
    overflow: hidden;
  }

  .score-slider {
    height: 100%;
    background-color: #4CAF50;
    transition: width 0.3s ease;
  }

  .auto-scroll {
    overflow-y: auto;
    max-height: 90vh;
  }
</style>

<body style="overflow: hidden;">
  <div class="score-slider-container" id="score-slider-container">
    <div class="score-slider" id="score-slider"></div>
  </div>
  <script>
    let changeMorphTargetByName
    let camera, scene, renderer, avatar, light
    let client = io()
    let isListening = false;
    let firstTime = true;
    let response = ""
    let micIndicator;
    let insideVR = false;
    let conversation_count = 0
    let left_eye = 0
    let right_eye = 0
    let blinkFlag = false;
    let score = 0;
    let current_prompt = hr_prompt


    let conversations = [];
    const url = "https://api.groq.com/openai/v1/chat/completions";
    const grokApiKey =
      "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";
    async function getFinalFeedback() {
      let tempData = {
        messages: [
          ...conversations
        ],
        "model": "llama-3.3-70b-versatile",
        "temperature": 1,
        "max_tokens": 1024,
        "top_p": 1,
        "stream": false,
        "stop": null
      }
      tempData.messages = tempData.messages.map(message => {
        const { topThreeEmotions, ...rest } = message;
        return rest;
      });
      tempData.messages.push({
        role: "system",
        content: `The interview session has been ended. Based on the conversation, write a summary or result of the interview round. Write with you word. Give a point based summary. Add score out of 10 for every point. Don't give markdown. Add - before each point. End each line with a :::`
      })
      tempData.messages.push({
        role: "user",
        content: "How did I do? Give me a point based summary. Don't give markdown. Write them line by line separated by :::"
      })

      return axios
        .post(url, tempData, {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${grokApiKey}`,
          },
        })
        .then((response) => {
          console.log("ðŸš€ ~ .then ~ response:", response)
          let responseLLM = response.data.choices[0].message.content;
        
          return responseLLM;
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    }
    function getFeedback(lastResponse) {
      let tempData = {
        messages: [
          ...conversations
        ],
        "model": "llama-3.3-70b-versatile",
        "temperature": 1,
        "max_tokens": 10,
        "top_p": 1,
        "stream": false,
        "stop": null
      }
      tempData.messages = tempData.messages.map(message => {
        const { topThreeEmotions, ...rest } = message;
        return rest;
      });
      tempData.messages.push(
        {
          role: "user",
          content: lastResponse
        },
        {
          role: "system",
          content: `Based on the conversation, give numerical feedback. Give a score between -1 to +1. -1 being the worst and +1 being the best. Prioritize user's last chat most for scoring. You can use fractional values. Only the value, nothing else.`
        },
        {
          role: "user",
          content: "How did I do? Give me a score between -1 to +1. -1 being the worst and +1 being the best. You can use fractional values. Only the value, nothing else."
        })
      console.log('tempData', tempData)
      return axios
        .post(url, tempData, {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${grokApiKey}`,
          },
        })
        .then((response) => {
          let responseLLM = response.data.choices[0].message.content;
          // data.messages.push({
          //     role: "assistant",
          //     content: responseLLM,
          // });
          // console.log(responseLLM);
          return responseLLM;
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    }


    let current_role = 'hr';
    let sessionEnded = false;

    function handleToggle(role) {
      const toggleButton = document.getElementById("toggle-button");
      toggleButton.innerHTML = role;

      switch (role) {
        case 'HR':
          current_role = 'hr'
          // updateSystemPrompt(hr_prompt)
          console.log('HR selected');
          current_prompt = hr_prompt;
          break;
        case 'Technical':
          current_role = 'technical'
          // updateSystemPrompt(technical_prompt)
          console.log('Technical selected');
          current_prompt = technical_prompt;
          break;
        case 'Barista':
          current_role = 'barista'
          // updateSystemPrompt(barista_prompt)
          console.log('Barista selected');
          current_prompt = barista_prompt;
          break;
        default:
          console.log('Unknown role selected');
      }
    }

    function updateScoreSlider(score) {
      const slider = document.getElementById('score-slider');
      let percentage
        = Math.abs((score + 5) * 10);
      console.log("ðŸš€ ~ updateScoreSlider ~ percentage:", percentage)
      slider.style.width = `${percentage}%`;
      slider.style.backgroundColor = score > 0 ? '#4CAF50' : score < 0 ? '#f44336' : '#ddd';
    }

    // Example usage:
    updateScoreSlider(score);
  </script>
  <div class="overlay">
    <div class="dropdown">
      <button class="speak-button" id="toggle-button">Select Role</button>
      <div class="dropdown-content">
        <button onclick="handleToggle('HR')">HR</button>
        <button onclick="handleToggle('Technical')">Technical</button>
        <button onclick="handleToggle('Barista')">Barista</button>
      </div>
    </div>
    <button class="speak-button" id="speak-button-id" style="display: none;"
      onclick="handleButtonClick()">Speak</button>
    <button class="speak-button" id="start-button">Start</button>
    <button class="speak-button" style="display: none; background-color: #f44336;" id="end-button">End</button>
  </div>
  <div class="conversation-user hidden" id="user-div">
    <p class="capitalize" id="user-text"></p>
  </div>
  <div class="conversation-avatar hidden" id="interviewer-div">
    <p class="capitalize" id="interviewer-text"></p>
  </div>
  <div class="conversation" id="conversation"></div>
  <audio id="audioPlayback" hidden controls>
    <source id="audioSource" type="audio/mp3" src="" />
  </audio>
</body>

</html>